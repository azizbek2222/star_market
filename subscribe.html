<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subscribe</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#0e1621;
  color:#fff;
  padding:20px;
}
h1{
  text-align:center;
  color:#4fc3f7;
}
#coin{
  text-align:center;
  color:#ffca28;
  margin-bottom:20px;
}
.channel{
  background:#1b2430;
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.channel b{
  color:#4fc3f7;
}
button{
  padding:8px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  background:#4caf50;
  color:#fff;
}
button:hover{
  background:#43a047;
}
</style>
</head>

<body>

<h1>Subscribe Channels</h1>
<h2 id="coin">Coins: 0</h2>

<div id="channels"></div>

<!-- Telegram Mini App -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script type="module">
/* ---------------- FIREBASE ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA7VLHdjPqf_tobSiBczGbN8H7YlFwq9Wg",
  authDomain: "magnetic-alloy-467611-u7.firebaseapp.com",
  databaseURL: "https://magnetic-alloy-467611-u7-default-rtdb.firebaseio.com",
  projectId: "magnetic-alloy-467611-u7",
  storageBucket: "magnetic-alloy-467611-u7.firebasestorage.app",
  messagingSenderId: "589500919880",
  appId: "1:589500919880:web:15c3e68f5e7e1fbf51687d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ---------------- TELEGRAM USER ---------------- */
const tg = window.Telegram.WebApp;
tg.ready();

if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
  // Telegram login YO‘Q → index.html ga qaytaradi
  window.location.href = "index.html";
  throw new Error("Telegram login yo‘q");
}

const tgUser = tg.initDataUnsafe.user;
const userId = tgUser.id;
const userName = tgUser.first_name || "User";

/* ---------------- REFS ---------------- */
const userRef = ref(db, "users/" + userId);
const ordersRef = ref(db, "orders");

/* ---------------- USER CREATE / UPDATE ---------------- */
const userSnap = await get(userRef);
if (!userSnap.exists()) {
  await set(userRef, {
    name: userName,
    coin: 0
  });
}

/* ---------------- COIN REALTIME ---------------- */
onValue(userRef, snap => {
  document.getElementById("coin").innerText =
    "Coins: " + (snap.val().coin || 0);
});

/* ---------------- TELEGRAM BOT ---------------- */
const BOT_TOKEN = "8548586153:AAFi-FS-DDpJCk-uydMkPMUQBpSuEc4BYkE";

/* ---------------- CHANNEL LIST ---------------- */
onValue(ordersRef, snap => {
  const box = document.getElementById("channels");
  box.innerHTML = "";

  snap.forEach(orderSnap => {
    const order = orderSnap.val();
    const orderId = orderSnap.key;

    const div = document.createElement("div");
    div.className = "channel";
    div.innerHTML = `
      <b>${order.channel}</b>
      <button id="btn-${orderId}">Subscribe</button>
    `;
    box.appendChild(div);

    document.getElementById("btn-" + orderId).onclick = async () => {

      // TELEGRAM OBUNA TEKSHIRISH
      fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getChatMember?chat_id=${order.channel}&user_id=${userId}`)
        .then(r => r.json())
        .then(async data => {

          if (!data.ok) {
            alert("Tekshiruv xatosi");
            return;
          }

          const status = data.result.status;
          if (status === "member" || status === "administrator" || status === "creator") {

            const u = (await get(userRef)).val();
            await update(userRef, {
              coin: (u.coin || 0) + 1
            });

            alert("✅ Obuna tasdiqlandi +1 coin");

          } else {
            alert("❌ Avval kanalga obuna bo‘ling");
            window.open("https://t.me/" + order.channel.replace("@",""), "_blank");
          }

        });
    };
  });
});
</script>

</body>
</html>