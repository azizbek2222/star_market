<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Telegram Login + Firebase</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyA7VLHdjPqf_tobSiBczGbN8H7YlFwq9Wg",
    authDomain: "magnetic-alloy-467611-u7.firebaseapp.com",
    databaseURL: "https://magnetic-alloy-467611-u7-default-rtdb.firebaseio.com",
    projectId: "magnetic-alloy-467611-u7",
    storageBucket: "magnetic-alloy-467611-u7.firebasestorage.app",
    messagingSenderId: "589500919880",
    appId: "1:589500919880:web:15c3e68f5e7e1fbf51687d",
    measurementId: "G-TD0N13MPX3"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Telegram Auth callback
  window.onTelegramAuth = function(user) {
    const userRef = ref(db, 'users/' + user.id);

    let firstName = user.first_name || "NoName";
    let username = user.username || "";

    // Check if user exists
    get(child(ref(db), 'users/' + user.id)).then((snapshot) => {
      if(snapshot.exists()){
        // Existing user
        window.location.href = "home.html?user=" + user.id;
      } else {
        // New user
        set(userRef, {
          name: firstName,
          username: username,
          coin: 100
        }).then(() => {
          window.location.href = "home.html?user=" + user.id;
        }).catch(err => {
          console.error("Firebase error:", err);
          alert("Login failed!");
        });
      }
    }).catch(err => {
      console.error("Firebase error:", err);
      alert("Login failed!");
    });
  }
</script>
</head>
<body style="background:#0e1621;color:#fff;font-family:Arial;text-align:center;padding:50px;">

<h1>Login with Telegram</h1>

<!-- Telegram Login Widget -->
<script async src="https://telegram.org/js/telegram-widget.js?22"
  data-telegram-login="star_members_robot"
  data-size="large"
  data-userpic="true"
  data-lang="en"
  data-onauth="onTelegramAuth(user)">
</script>

<p style="font-size:12px;color:#aaa;margin-top:10px">
  Safe login. We never ask for SMS code.
</p>

</body>
</html>